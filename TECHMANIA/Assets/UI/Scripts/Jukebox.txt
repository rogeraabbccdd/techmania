jukebox = {
    enabled = false,

    -- Each element is a table:
    -- {
    --   trackInFolder
    --   patternMetadata
    -- }
    playlist = {},
    currentTrack = 0  -- 1-index
}

jukebox.BuildPlaylist = function(location, includeSubfolders)
    jukebox.playlist = {}
    function SearchAndProcessFolder(folder)
        for _, trackInFolder in ipairs(tm.resources.GetTracksInFolder(folder)) do
            -- Pick a pattern from this track. It's usually the most difficult Touch pattern,
            -- but if no Touch patterns exist, use Keys, and if no keys, use KM.
            local hardestPattern = {}
            hardestPattern[tm.enum.controlScheme.Touch] = nil
            hardestPattern[tm.enum.controlScheme.Keys] = nil
            hardestPattern[tm.enum.controlScheme.KM] = nil
            for _, pattern in ipairs(trackInFolder.minimizedTrack.patterns) do
                local level = pattern.patternMetadata.level
                local scheme = pattern.patternMetadata.controlScheme
                if (hardestPattern[scheme] == nil or level >= hardestPattern[scheme].patternMetadata.level) then
                    hardestPattern[scheme] = pattern
                end
            end

            local chosenPattern = hardestPattern[tm.enum.controlScheme.Touch]
            if (chosenPattern == nil) then
                chosenPattern = hardestPattern[tm.enum.controlScheme.Keys]
            end
            if (chosenPattern == nil) then
                chosenPattern = hardestPattern[tm.enum.controlScheme.KM]
            end

            if (chosenPattern != nil) then
                table.insert(jukebox.playlist, {
                    trackInFolder = trackInFolder,
                    patternMetadata = chosenPattern.patternMetadata })
            end
        end
        if (includeSubfolders) then
            for _, subfolder in ipairs(tm.resources.GetTrackSubfolders(folder)) do
                SearchAndProcessFolder(subfolder.fullPath)
            end
        end
    end
    SearchAndProcessFolder(location)
end

jukebox.BackupAndReplaceModifiers = function()
    -- TODO
end

jukebox.RestoreModifiers = function()
    -- TODO
end

jukebox.SetupCurrentTrack = function()
    tm.gameSetup.setlist.enabled = false
    tm.gameSetup.trackFolder = jukebox.playlist[jukebox.currentTrack].trackInFolder.folder
    tm.gameSetup.patternGuid = jukebox.playlist[jukebox.currentTrack].patternMetadata.guid
end